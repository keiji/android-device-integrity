openapi: 3.0.0
info:
  title: Play Integrity API Service
  version: v1
  description: |-
    Provides endpoints for interacting with the Google Play Integrity API.
    Allows clients to request a nonce and verify device integrity tokens.
  contact:
    name: API Support
    url: http://www.example.com/support
    email: support@example.com

tags:
  - name: PlayIntegrityClassic
    description: Operations related to the classic Play Integrity API requests.
  - name: PlayIntegrityStandard
    description: Operations related to the standard Play Integrity API requests.

servers:
  - url: http://localhost:8080 # Replace with your actual server URL in production
    description: Development server

paths:
  /play-integrity/classic/nonce:
    post:
      summary: Create Nonce
      description: |-
        Generates a cryptographically secure nonce, stores it, and returns it.
        This nonce should be used by the client when requesting an integrity token
        from the Play Integrity API.
      operationId: createNonce
      tags:
        - PlayIntegrityClassic
      # Removed requestBody as it's not needed for this endpoint
      responses:
        '200':
          description: Nonce created successfully.
          content:
            application/json:
              schema:
                type: object
                required: # Added required for nonce and generated_datetime
                  - nonce
                  - generated_datetime
                properties:
                  nonce:
                    type: string
                    description: The base64 URL-safe encoded nonce.
                    example: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890-_"
                  generated_datetime:
                    type: integer # Kept as integer, format int64 is correct for epoch milliseconds
                    format: int64
                    description: The server time in epoch milliseconds when the nonce was generated.
                    example: 1678886400000
        '500':
          description: Internal server error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /play-integrity/classic/verify:
    post:
      summary: Verify Integrity Token
      description: |-
        Verifies an integrity token obtained from the client against the Google Play Integrity API.
        The request must include the nonce that was originally provided to the client and the
        integrity token itself.
      operationId: verifyIntegrityToken
      tags:
        - PlayIntegrityClassic
      requestBody:
        description: JSON payload containing the nonce and the integrity token.
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nonce
                - token
              properties:
                nonce:
                  type: string
                  description: The nonce that was previously obtained from the /play-integrity/classic/nonce endpoint.
                  example: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890-_"
                token:
                  type: string
                  description: The integrity token received from the client (from Play Integrity API).
                  example: "long.integrity.token.string.from.client"
      responses:
        '200':
          description: Integrity token verified successfully. The response is the direct JSON output from the Google Play Integrity API.
          content:
            application/json:
              schema:
                type: object
                required: # Added required for tokenPayloadExternal
                  - tokenPayloadExternal
                properties:
                  tokenPayloadExternal:
                    $ref: '#/components/schemas/TokenPayloadExternal' # Referenced common schema
        '400':
          description: Bad request. This can be due to a missing JSON payload, missing 'nonce' or 'token' in the request, or a nonce mismatch.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ErrorResponse'
                  - $ref: '#/components/schemas/NonceMismatchErrorResponse'
        '500':
          description: Internal server error. This can be due to server authentication configuration issues or other failures in verifying the integrity token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /play-integrity/standard/verify:
    post:
      summary: Verify Integrity Token (Standard)
      description: |-
        Verifies an integrity token obtained from the client against the Google Play Integrity API (Standard tier).
        The request must include the nonce that was originally provided to the client and the
        integrity token itself. The Standard API may provide more detailed device and app integrity information.
      operationId: verifyIntegrityTokenStandard
      tags:
        - PlayIntegrityStandard
      requestBody:
        description: JSON payload containing the nonce and the integrity token.
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nonce
                - token
              properties:
                nonce:
                  type: string
                  description: The nonce that was previously obtained (e.g., from /play-integrity/classic/nonce).
                  example: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890-_"
                token:
                  type: string
                  description: The integrity token received from the client (from Play Integrity API using Standard request).
                  example: "long.standard.integrity.token.string.from.client"
      responses:
        '200':
          description: Integrity token verified successfully using Standard API features. The response is the direct JSON output from the Google Play Integrity API.
          content:
            application/json:
              schema:
                type: object
                required: # Added required for tokenPayloadExternal
                  - tokenPayloadExternal
                properties:
                  tokenPayloadExternal:
                    $ref: '#/components/schemas/TokenPayloadExternal' # Referenced common schema
        '400':
          description: Bad request. Missing payload, 'nonce'/'token', or nonce mismatch.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ErrorResponse'
                  - $ref: '#/components/schemas/NonceMismatchErrorResponse'
        '500':
          description: Internal server error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    TokenPayloadExternal: # Defined common TokenPayloadExternal schema
      type: object
      description: Contains the decoded integrity verdict from Google Play Integrity API.
      # Required fields based on typical Play Integrity responses and examples.
      # Server should ensure these are present if it's a successful decoding.
      required:
        - requestDetails
        - appIntegrity
        - deviceIntegrity
        - accountDetails
      properties:
        requestDetails:
          type: object
          required: # Common required fields for requestDetails
            - requestPackageName
            - nonce
            - timestampMillis
          properties:
            requestPackageName:
              type: string
              example: "dev.keiji.deviceintegrity"
            nonce: # Nonce is present in classic, requestHash in standard.
                    # Making nonce required here as it's common, standard might use requestHash instead/additionally.
              type: string
              example: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890-_"
            requestHash: # More common in Standard API
              type: string
              nullable: true # Allow null if not present (e.g. in Classic)
              example: "request_hash_example_for_standard"
            timestampMillis:
              type: integer # Changed to integer
              format: int64
              description: Timestamp in epoch milliseconds.
              example: 1678886400123
        appIntegrity:
          type: object
          required: # Common required fields for appIntegrity
            - appRecognitionVerdict
            - packageName
            - certificateSha256Digest
            - versionCode
          properties:
            appRecognitionVerdict:
              type: string
              example: "PLAY_RECOGNIZED"
            packageName:
              type: string
              example: "dev.keiji.deviceintegrity"
            certificateSha256Digest:
              type: array
              items:
                type: string
              example: ["sha256_cert_digest"]
            versionCode:
              type: integer # Changed to integer
              description: Application version code.
              example: 123
        deviceIntegrity:
          type: object
          required: # deviceRecognitionVerdict is key
            - deviceRecognitionVerdict
          properties:
            deviceRecognitionVerdict:
              type: array
              items:
                type: string
              example: ["MEETS_DEVICE_INTEGRITY"]
            deviceAttributes: # Standard API, optional
              type: object
              nullable: true
              properties:
                sdkVersion:
                  type: string # Kept as string, as actual API might send it as such
                  example: "30"
            recentDeviceActivity: # Standard API, optional
              type: object
              nullable: true
              properties:
                deviceActivityLevel:
                  type: string
                  example: "LEVEL_2"
        accountDetails:
          type: object
          required: # appLicensingVerdict is key
            - appLicensingVerdict
          properties:
            appLicensingVerdict:
              type: string
              example: "LICENSED"
        environmentDetails: # Optional, more common in Standard API
          type: object
          nullable: true
          properties:
            playProtectVerdict:
              type: string
              example: "NO_ISSUES"
            appAccessRiskVerdict: # Standard API, optional
              type: object
              nullable: true
              properties:
                appsDetected:
                  type: array
                  items:
                    type: string
                  example: ["com.example.someapp"]
      example:
        requestDetails:
          requestPackageName: "dev.keiji.deviceintegrity"
          nonce: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890-_"
          timestampMillis: 1678886400123
        appIntegrity:
          appRecognitionVerdict: "PLAY_RECOGNIZED"
          packageName: "dev.keiji.deviceintegrity"
          certificateSha256Digest: ["sha256_cert_digest"]
          versionCode: 123
        deviceIntegrity:
          deviceRecognitionVerdict: ["MEETS_DEVICE_INTEGRITY"]
        accountDetails:
          appLicensingVerdict: "LICENSED"
        environmentDetails:
          playProtectVerdict: "NO_ISSUES"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: A message describing the error.
          example: "Failed to generate nonce"
    NonceMismatchErrorResponse:
      type: object
      required:
        - error
        - client_nonce
        - api_nonce
      properties:
        error:
          type: string
          description: A message indicating a nonce mismatch.
          example: "Nonce mismatch"
        client_nonce:
          type: string
          description: The nonce provided by the client.
          example: "client_provided_nonce"
        api_nonce:
          type: string
          description: The nonce found in the Play Integrity API response.
          example: "api_response_nonce"
        play_integrity_response: # Optional, included if server decides to send it
          description: The full response from the Play Integrity API, included for debugging.
          $ref: '#/components/schemas/TokenPayloadExternal' # Referenced common schema
  securitySchemes: {}
