# Backend Server for Android Device Integrity

This directory contains the backend server component of the Android Device Integrity project. It consists of two separate Python Flask applications designed to be deployed as independent services, typically on a serverless platform like Google Cloud Run.

1.  **Key Attestation Service (`key_attestation/`)**: Provides endpoints for verifying hardware-backed key attestations.
2.  **Play Integrity Service (`play_integrity/`)**: Manages nonce generation and verification of Play Integrity tokens from the Android client.

## 1. Key Attestation Service

This service is responsible for validating the integrity of application keys by verifying their attestation certificates.

### API Endpoints

The API is defined in `key_attestation/openapi.yaml`. Refer to this file for detailed specifications of requests, responses, and data models.

### Deployment

The service is designed to be deployed as a container on Google Cloud Run. The service name on Cloud Run is `key-attestation-verify`.

---

## 2. Play Integrity Service

This service supports the backend verification process for the Google Play Integrity API.

### API Endpoints

The API is documented using OpenAPI v3 in `play_integrity/openapi.yaml`.

-   **`/play-integrity/classic/nonce` (POST)**
    -   **Description**: Generates a cryptographically secure nonce for the client app to use with the Play Integrity API.
    -   **Response**: `200 OK` with a JSON body containing the `nonce` and its `generated_datetime`.

-   **`/play-entropy/classic/verify` (POST)**
    -   **Description**: Verifies an integrity token received from the client. This involves calling the Google Play Integrity API and checking that the nonce in the token matches the one generated by this server.
    -   **Request Body**: A JSON object containing the `nonce` and the integrity `token`.
    -   **Response**:
        -   `200 OK`: The JSON response from the Google Play Integrity API, indicating successful verification.
        -   `400 Bad Request`: If the request is malformed or the nonce does not match.

### Environment Variables

-   `PLAY_INTEGRITY_PACKAGE_NAME`: Sets the Android package name (`applicationId`) for the Google Play Integrity API call. This is useful for supporting different build variants (e.g., debug/release).
    -   **Default**: `dev.keiji.deviceintegrity`

---

## 3. Setup and Deployment

Both services can be deployed to Google Cloud Run automatically via GitHub Actions or manually.

### Prerequisites

*   Google Cloud SDK (`gcloud`)
*   Docker
*   Python 3.9+
*   `pip`

### Automated Deployment (GitHub Actions)

The repository includes a GitHub Actions workflow (`.github/workflows/cloud_run_deploy.yml`) that automatically builds and deploys both services when changes are pushed to the `deploy/cloudrun` branch.

**Required GitHub Secrets:**

*   `GCP_PROJECT_ID`: Your Google Cloud Project ID.
*   `GCP_CLOUD_RUN_REGION`: The region for deployment (e.g., `us-central1`).
*   `GCP_SA_KEY`: A JSON key for a Google Cloud service account with permissions to deploy to Cloud Run and push to the container registry.

### Manual Deployment to Cloud Run

Follow these steps for each service (`key_attestation` and `play_integrity`).

1.  **Build and Push Docker Image:**
    Navigate to the service directory (e.g., `server/key_attestation`) and use Docker or Google Cloud Build to create and push the container image to a registry like Google Artifact Registry.

    *Using Cloud Build (recommended):*
    ```bash
    # From within server/key_attestation/
    gcloud builds submit --tag YOUR_REGION-docker.pkg.dev/YOUR_PROJECT_ID/YOUR_ARTIFACT_REPO/keyattestationverify-image:latest .
    ```

2.  **Deploy to Cloud Run:**
    Deploy the image to Cloud Run using the `gcloud run deploy` command.

    *Deploying the Key Attestation service:*
    ```bash
    gcloud run deploy key-attestation-verify \
        --image YOUR_REGION-docker.pkg.dev/YOUR_PROJECT_ID/YOUR_ARTIFACT_REPO/keyattestationverify-image:latest \
        --platform managed \
        --region YOUR_DEPLOY_REGION \
        --allow-unauthenticated
    ```

    *Deploying the Play Integrity service:*
    ```bash
    gcloud run deploy play-integrity-verify \
        --image YOUR_REGION-docker.pkg.dev/YOUR_PROJECT_ID/YOUR_ARTIFACT_REPO/playintegrityverify-image:latest \
        --platform managed \
        --region YOUR_DEPLOY_REGION \
        --allow-unauthenticated
    ```

### Local Development

You can run each Flask application locally for testing.

1.  **Install Dependencies:**
    ```bash
    # For key_attestation
    pip install -r server/key_attestation/requirements.txt

    # For play_integrity
    pip install -r server/play_integrity/requirements.txt
    ```

2.  **Run the Server:**
    ```bash
    # Run key_attestation on port 8081
    cd server/key_attestation && flask run -p 8081

    # Run play_integrity on port 8082
    cd server/play_integrity && flask run -p 8082
    ```
